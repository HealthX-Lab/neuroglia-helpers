#!/bin/bash

cpus=4
mem=32000
minutes=30


if [ "$#" -lt 1 ]
then
	echo "Usage: $0 <URI>" >&2
	echo "" >&2
	echo "Checks if singularity container is cached and ready to run, running download with salloc/srun if not" >&2
	echo " - use this to download and cache your singularity containers, since this cannot be done on login node -" >&2
	echo "" >&2
	echo " e.g: $0 docker://khanlab/tar2bids:latest" >&2
	exit 1
fi


url=$1

# if SINGULARITY_TMPDIR is not set, then we cannot pull locally, need to submit job
if [ "$SINGULARITY_TMPDIR" = "" ]
then
	# so if singularity run takes longer than 5s, container is not cached..
	echo  "Checking if container is already downloaded ... " >&2
	timeout 10s singularity run $url > /dev/null

	case $? in 
		255) echo "ERROR: Container does not exist" >&2; exit 1;;

		124) echo "Container not downloaded, allocating job to download ... " >&2
		# so run the command on an interactive job instead
		salloc -J shub-cache -D `pwd` --time=0:${minutes}:00 --cpus-per-task=$cpus --ntasks=1 --mem=$mem --account=$CC_COMPUTE_ALLOC srun singularity run $url >&2 ;;
	esac	
fi

#at this point, it is downloaded, or we are on node that supports download
singularity run $url >&2
if [ "$?" == 255 ]
then
echo "ERROR: Container does not exist" >&2
exit 1
fi

echo "Ready to run:" >&2
echo $url
exit 0

